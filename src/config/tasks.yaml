# ==============================================================================
# TASK CONFIGURATION
# ------------------------------------------------------------------------------
# This file defines the 8 sequential tasks for the Resume Tailor Crew.
# Each task has a clear description of what the assigned agent should do and
# a definition of the "expected_output" which serves as its goal.
#
# WHY YAML?
# - Clarity: Task definitions are centralized and easy to read.
# - Maintainability: You can change task descriptions or expected outputs
#   without modifying the core Python logic.
# - Context Management: The `context` key explicitly defines the data flow
#   and dependencies between tasks.
# ==============================================================================

# ============================================================================
# PHASE 1: DATA EXTRACTION & ANALYSIS (Parallel Tasks)
# ----------------------------------------------------------------------------
# These initial tasks can run in parallel as they have no dependencies on
# each other. They focus on parsing and structuring the input documents.
# ============================================================================

analyze_job_description_task:
  # A detailed description of the agent's objective for this task.
  # It provides step-by-step instructions for the LLM.
  description: >
    Analyze the provided job description content to extract and structure all relevant information.
    
    IMPORTANT: The job description content is already provided in clean Markdown format in the
    CONTEXT section below. DO NOT attempt to use file-parsing tools or load files. Simply analyze
    the content that has been provided to you.
    
    Your task is to:
    1. Analyze the job description content from the CONTEXT section.
    2. Extract the job title, company name, and identify the seniority level.
    3. Identify all requirements and qualifications, categorizing each as:
       - Must-have (e.g., required, mandatory, essential)
       - Should-have (e.g., preferred, desired)
       - Nice-to-have (e.g., bonus, plus)
    4. Extract specific skills mentioned, paying close attention to technical skills,
       required years of experience, and necessary certifications.
    5. Identify key responsibilities and what success looks like in the role.
    6. Extract company culture indicators from the language and tone used.
    7. Compile a comprehensive list of ATS keywords that are critical for the resume.
    Use your expertise in reading between the lines to identify implicit requirements.
    Output a structured `JobDescription` model with your complete analysis.
  
  # Defines the success criteria for the task. The agent will work until its
  # output matches this description of a completed task.
  expected_output: >
    A comprehensive JSON object representing a `JobDescription`. This object must include:
    - Job title and company name.
    - The detected seniority level.
    - A categorized list of requirements (at least 20 items with importance levels).
    - A list of must-have keywords for ATS optimization.
    - A breakdown of key responsibilities.
    - Insights into the company culture.
    The output must be a valid JSON that conforms to the `JobDescription` model structure.
  
  # Specifies which agent is responsible for this task.
  agent: job_description_analyst
  
  # Defines where the output of this task will be saved.
  output_file: analysis/job_analysis.json

extract_resume_content_task:
  description: >
    Extract and structure the candidate's resume information using LLM-based extraction.
    
    IMPORTANT: The resume content is already provided in clean Markdown format in the
    CONTEXT section below (converted from the original PDF/DOCX file). DO NOT attempt to
    use file-parsing tools or load files. Simply analyze the content that has been provided to you.
    
    Your task is to:
    1. Analyze the resume Markdown content from the CONTEXT section.
    2. Extract all information into a structured `Resume` model, including:
       - Personal information (name, email, phone, location).
       - The professional summary or objective.
       - All work experience entries with job titles, companies, dates, descriptions,
         quantifiable achievements, and skills used in each role.
       - The education section with degrees, institutions, and graduation years.
       - The skills section, categorized into technical, soft, and domain-specific skills.
    3. Identify patterns of career growth and areas of deep expertise.
    4. Calculate the total years of professional experience.
    5. Ensure the accuracy and completeness of all extracted data.
    Output a structured `Resume` model with the complete career history.
  expected_output: >
    A comprehensive JSON object representing a `Resume`. This object must include:
    - Complete personal information.
    - The professional summary.
    - All work experiences (at least 3 entries) with detailed achievements.
    - A full education history.
    - A categorized list of skills (at least 20 skills).
    - A calculation of the total years of experience.
    The output must be a valid JSON that conforms to the `Resume` model structure.
  agent: resume_content_extractor
  output_file: analysis/resume_extraction.json

# ============================================================================
# PHASE 2: STRATEGIC ANALYSIS
# ----------------------------------------------------------------------------
# This task depends on the outputs of Phase 1 to create the tailoring strategy.
# ============================================================================

create_alignment_strategy_task:
  description: >
    Create a comprehensive strategy for aligning the resume with the job requirements.
    
    CRITICAL: You MUST output a valid JSON object that includes ALL of the following required fields.
    Missing any of these fields will cause validation errors.
    
    REQUIRED FIELDS (ALL MANDATORY):
    1. overall_fit_score (float, 0-100): Numeric score representing overall compatibility
    2. summary_of_strategy (string): High-level strategic summary (2-3 sentences)
    3. professional_summary_guidance (string): Specific instructions for the Professional Summary Writer
    4. experience_guidance (string): Specific instructions for the Experience Optimizer
    5. skills_guidance (string): Specific instructions for the Skills Optimizer
    6. identified_matches (list): List of SkillMatch objects (can be empty list if no matches)
    7. identified_gaps (list): List of SkillGap objects (can be empty list if no gaps)
    8. keywords_to_integrate (list): List of keyword strings (at least 15 keywords)
    
    YOUR ANALYSIS WORKFLOW:
    1. Compare the extracted job requirements against the candidate's experience and skills.
    2. Identify all skill matches, categorizing them as direct, transferable, or implicit.
    3. Calculate a match percentage for each requirement.
    4. Identify all skill gaps, assessing whether they are deal-breakers or addressable.
    5. Create strategic recommendations on which experiences to emphasize, how to reframe
       achievements, which skills to prioritize, and which keywords must be incorporated.
    6. Develop content guidance for each section of the resume (summary, experience, skills).
    7. Set a target keyword density and identify high-priority keywords for ATS optimization.
    
    FIELD-BY-FIELD GUIDANCE:
    
    - overall_fit_score: Calculate a numeric score (0-100) based on:
      * Percentage of must-have requirements met (40% weight)
      * Percentage of should-have requirements met (30% weight)
      * Years of experience alignment (20% weight)
      * Domain/industry match (10% weight)
    
    - summary_of_strategy: Write 2-3 sentences describing the core strategy, e.g.:
      "Emphasize backend development and cloud infrastructure experience while integrating 
      DevOps keywords. Reframe microservices projects to highlight scalability and cost savings.
      Downplay frontend work and focus on system architecture achievements."
    
    - professional_summary_guidance: Provide specific instructions for the summary writer, e.g.:
      "Lead with '5+ years of backend development experience'. Mention Go, PostgreSQL, and 
      Kubernetes in the first sentence. Include a quantifiable achievement related to system 
      scalability or cost reduction. End with alignment to the company's cloud-first mission."
    
    - experience_guidance: Provide specific instructions for each major role, e.g.:
      "For the 'Senior Engineer at TechCorp' role: Rewrite the first bullet to emphasize 
      microservices architecture using Go and Kafka. Add metrics showing system throughput 
      improvements. For the 'Developer at StartupCo' role: Condense to 2-3 bullets focusing 
      only on backend API development, remove frontend work."
    
    - skills_guidance: Provide specific instructions for skills organization, e.g.:
      "Create a 'Backend Technologies' category with Go, Python, RESTful APIs listed first.
      Add a 'Cloud & DevOps' category with AWS, Docker, Kubernetes. Remove jQuery and 
      Bootstrap as they're not relevant. Ensure PostgreSQL and Kafka appear prominently."
    
    - identified_matches: List of objects with structure:
      {
        "resume_skill": "Django Framework",
        "job_requirement": "Experience with Python web frameworks",
        "match_score": 90.0,
        "justification": "Django is a popular Python web framework, directly fulfilling the requirement."
      }
    
    - identified_gaps: List of objects with structure:
      {
        "missing_skill": "Kubernetes",
        "importance": "must_have",
        "suggestion": "Review project experience for any container orchestration work that can be highlighted."
      }
    
    - keywords_to_integrate: List of at least 15 high-priority keywords from the job description, e.g.:
      ["Go", "RESTful APIs", "microservices", "PostgreSQL", "Kafka", "RabbitMQ", "Docker", 
       "Kubernetes", "AWS", "cloud infrastructure", "CI/CD", "Agile", "scalability", "system design"]
    
    PRE-OUTPUT VALIDATION CHECKLIST:
    Before outputting your JSON, verify:
    ✓ overall_fit_score is a number between 0-100
    ✓ summary_of_strategy is a non-empty string (2-3 sentences)
    ✓ professional_summary_guidance is a non-empty string with specific instructions
    ✓ experience_guidance is a non-empty string with specific instructions
    ✓ skills_guidance is a non-empty string with specific instructions
    ✓ identified_matches is a list (can be empty [])
    ✓ identified_gaps is a list (can be empty [])
    ✓ keywords_to_integrate is a list with at least 15 keywords
    
    Be analytical but also creative in identifying matches. Many apparent gaps are simply
    differences in terminology. Remain honest about true gaps and suggest how to address them
    without fabrication.
  expected_output: >
    A complete JSON object conforming to the AlignmentStrategy model structure.
    
    EXACT STRUCTURE REQUIRED:
    {
      "overall_fit_score": 78.5,
      "summary_of_strategy": "Emphasize backend development and cloud infrastructure experience while integrating DevOps keywords. Reframe microservices projects to highlight scalability achievements.",
      "identified_matches": [
        {
          "resume_skill": "Python",
          "job_requirement": "Backend development with Python or Go",
          "match_score": 95.0,
          "justification": "5+ years of Python backend development directly matches requirement."
        }
      ],
      "identified_gaps": [
        {
          "missing_skill": "Kubernetes",
          "importance": "must_have",
          "suggestion": "Review containerization projects for any orchestration work that can be highlighted."
        }
      ],
      "keywords_to_integrate": ["Go", "RESTful APIs", "microservices", "PostgreSQL", "Kafka", "Docker", "Kubernetes", "AWS", "CI/CD", "Agile", "scalability", "system design", "cloud infrastructure", "DevOps", "monitoring"],
      "professional_summary_guidance": "Lead with '5+ years of backend development experience'. Mention Python, PostgreSQL, and cloud technologies in the first sentence. Include a quantifiable achievement related to system scalability.",
      "experience_guidance": "For 'Senior Engineer at TechCorp': Rewrite bullets to emphasize microservices architecture and API development. Add metrics showing performance improvements. For 'Developer at StartupCo': Focus on backend work only.",
      "skills_guidance": "Create 'Backend Technologies' category with Python, Go, RESTful APIs first. Add 'Cloud & DevOps' category with AWS, Docker, Kubernetes. Remove outdated frontend skills."
    }
    
    VALIDATION REQUIREMENTS:
    - All 8 fields must be present (no missing fields)
    - overall_fit_score must be a number (0-100)
    - All guidance fields must contain specific, actionable instructions
    - keywords_to_integrate must have at least 15 keywords
    - identified_matches and identified_gaps can be empty lists but must be present
  
  # This task depends on the completion of the two tasks above.
  # The output of these tasks will be available in this task's context.
  context:
    - analyze_job_description_task
    - extract_resume_content_task
  agent: gap_alignment_strategist
  output_file: analysis/alignment_strategy.json

# ============================================================================
# PHASE 3: CONTENT GENERATION
# ----------------------------------------------------------------------------
# These tasks generate the new, tailored content based on the strategy.
# ============================================================================

write_professional_summary_task:
  description: >
    Write a compelling professional summary tailored to the target job.
    Your task is to generate 4 distinct drafts using different strategic frameworks.
    
    IMPORTANT: You must output a valid JSON object directly. Do NOT attempt to use tools.
    Perform all analysis and self-critique internally, then output the final structured result.
    
    Generate these 4 drafts:
    
    1. **Draft A (The Hook-Value-Future Framework)**:
       - Sentence 1 (Hook): Lead with the most impressive fact/number.
       - Sentences 2-3 (Value): Connect skills to outcomes ("Reduced X by Y%").
       - Final Sentence (Future): Align with company mission/values.
       
    2. **Draft B (The Story Spine)**:
       - Focus on the narrative arc: "Once upon a time... Until one day... And now..."
       - Emphasize career evolution and the "why" behind the candidate's path.
       
    3. **Draft C (The Specialist/Keyword Camouflage)**:
       - Maximize ATS keyword density but "camouflage" them within achievement contexts.
       - Focus on deep technical specificity and hard skills.
       
    4. **Draft D (The Balanced Hybrid)**:
       - The best balance of readability, impact, and ATS optimization.
       
    For each draft, internally perform:
    - "Specificity Test": Ensure every claim is backed by a number, tech, or outcome.
    - "Energy Audit": Ensure active voice and momentum.
    - Self-critique: Note strengths/weaknesses and assign a confidence score (0-100).
    
    Then output the complete JSON structure with all 4 drafts and your recommendation.
  expected_output: >
    A valid JSON object conforming to the ProfessionalSummary model structure:
    {
      "drafts": [
        {
          "version_name": "Hook-Value-Future",
          "strategy_used": "Brief description of strategy",
          "content": "The actual summary text (75-150 words)",
          "critique": "Self-critique of this draft",
          "score": 85
        },
        ... (3 more drafts)
      ],
      "recommended_version": "Hook-Value-Future",
      "writing_notes": "Overall notes about trade-offs between versions"
    }
    
    Each draft must be 75-150 words. Include all 4 drafts. Provide your recommendation.
  context:
    - create_alignment_strategy_task
  agent: professional_summary_writer
  output_file: content/professional_summary.txt

optimize_experience_section_task:
  description: >
    Rewrite and optimize all experience entries to align with the target job.
    Your task is to:
    1. Review each experience entry from the original resume.
    2. For each entry, reorder bullets by relevance to the target job:
       - Bullets with direct keyword matches go first
       - High-impact achievements (revenue, scale, cost savings) prioritized
       - Leadership/team accomplishments highlighted
       - Generic duties moved to end or removed
    3. Rewrite descriptions to incorporate job-relevant keywords naturally.
    4. Reframe achievements to emphasize the most relevant aspects.
    5. Quantify achievements wherever possible, using a Challenge-Action-Result (CAR) format.
    6. Ensure each bullet starts with a strong action verb (e.g., "Led", "Architected", "Increased").
    
    Apply the "So What?" Test to every bullet:
    - If a bullet describes WHAT you did without WHY it mattered, rewrite it.
    - Transform: "Built microservices" → "Built microservices architecture that reduced deployment time from 2 hours to 15 minutes"
    - Every bullet must answer: What business problem did this solve? Who benefited? What changed?
    
    Hierarchy of Impact (use highest level possible):
    1. Revenue/Cost: "Generated $2M in savings" (BEST)
    2. Efficiency: "Reduced processing time by 70%"
    3. Scale: "Enabled platform to support 50M users"
    4. Quality: "Decreased bug rate by 40%"
    5. Capability: "Enabled real-time analytics previously impossible"

    Bullet Structure Requirements:
    1. Lead with strong action verb
    2. Include context/scale early (team size, dataset size, user base)
    3. Specify method/technology used
    4. End with measurable impact
    
    Formula: "[Verb] [what] for [scale/context], [method], resulting in [impact]"
    
    Example: "Architected microservices platform for 50M+ users using Kubernetes and Python, 
              reducing infrastructure costs by $2M annually and improving deployment speed by 300%"

    ITERATIVE IMPROVEMENT PROCESS (MANDATORY):
    You MUST use the evaluate_experience_bullets tool for iterative improvement.
    DO NOT skip this process. Follow this exact workflow for EACH experience entry:
    
    FOR EACH experience entry (repeat this entire block per entry):
      Set ITERATION_COUNT = 0
      Set CONTINUE_IMPROVING = True
      Set iteration_history = []
      
      WHILE CONTINUE_IMPROVING AND ITERATION_COUNT < 3:
        ITERATION_COUNT = ITERATION_COUNT + 1
        
        # Step 1: Generate or Regenerate bullets
        IF ITERATION_COUNT == 1:
          bullets = [Generate 3-6 initial bullets based on original resume and strategy guidance]
        ELSE:
          bullets = [Regenerate 3-6 bullets addressing the specific critique from previous iteration]
        
        # Step 2: Evaluate using the tool (MANDATORY)
        evaluation_result = evaluate_experience_bullets(
          bullets_json=json.dumps(bullets),
          keywords="comma,separated,keywords,from,strategy"
        )
        
        # Step 3: Parse evaluation result
        Parse JSON from evaluation_result to get:
          - average_score (int)
          - per_bullet_scores (list)
          - issues (list of specific problems)
          - critique (actionable improvement instructions)
          - meets_threshold (bool)
        
        # Step 4: Record this iteration
        iteration_history.append({
          "iteration": ITERATION_COUNT,
          "content": "\n".join(bullets),
          "quality_score": average_score,
          "issues_found": issues,
          "critique": critique
        })
        
        # Step 5: Log progress
        LOG: "Iteration {ITERATION_COUNT} for {company_name}: Score {average_score}/100"
        
        # Step 6: Decide whether to continue
        IF meets_threshold:
          CONTINUE_IMPROVING = False
          LOG: "✓ Quality threshold met at iteration {ITERATION_COUNT}"
        ELSE IF ITERATION_COUNT >= 3:
          CONTINUE_IMPROVING = False
          LOG: "⚠ Max iterations reached. Final score: {average_score}/100"
        ELSE:
          LOG: "↻ Regenerating bullets based on critique: {critique}"
          # Loop will continue with regeneration
      
      # Step 7: Store final bullets and history for this entry
      final_bullets = bullets
      final_score = average_score
    
    OUTPUT FORMAT REQUIREMENTS:
    You MUST output using the IterativeExperienceOptimization model:
    {
      "optimized_experiences": [Experience objects with final bullets],
      "optimization_notes": "Summary of optimization decisions",
      "keywords_integrated": ["list", "of", "keywords", "used"],
      "relevance_scores": {"Company Name": relevance_score},
      "iteration_history": {
        "Company Name": [list of BulletDraft objects showing each iteration]
      },
      "iterations_used": total_number_of_iterations_across_all_entries,
      "final_quality_score": average_final_score_across_all_entries
    }
    
    CRITICAL: You MUST call evaluate_experience_bullets after generating bullets.
    CRITICAL: You MUST regenerate bullets if score < 85.
    CRITICAL: You MUST include iteration_history in your output.
    
    ════════════════════════════════════════════════════════════════════════════════
    CRITICAL OUTPUT REQUIREMENT - FINAL BULLET POINTS DISPLAY
    ════════════════════════════════════════════════════════════════════════════════
    
    AFTER your JSON output, you MUST ALWAYS add a human-readable section that clearly
    displays the final optimized bullet points. This section MUST be titled exactly:
    
    === FINAL OPTIMIZED BULLET POINTS ===
    
    This section is REQUIRED and makes it easy for users to see the final results at a glance.
    DO NOT skip this section. It must appear after your JSON output.
    
    Format for the FINAL BULLET POINTS section:
    
    === FINAL OPTIMIZED BULLET POINTS ===
    
    [Job Title] at [Company Name] ([Start Date] - [End Date or Present])
    Final Quality Score: [Score]/100
    
    • [First optimized bullet point]
    • [Second optimized bullet point]
    • [Third optimized bullet point]
    [Add more bullets as needed]
    
    [Repeat this format for EACH experience entry]
    
    Example:
    
    === FINAL OPTIMIZED BULLET POINTS ===
    
    Software Engineer at Test Company (Jan 2021 - Present)
    Final Quality Score: 88/100
    
    • Architected microservices platform for 50M+ users using Kubernetes and Python, reducing infrastructure costs by 40%
    • Led cross-functional team of 8 engineers using Agile methodologies, delivering $2M cost-saving automation initiative
    • Engineered CI/CD pipeline using Docker and AWS, improving release frequency by 300%
    
    Senior Engineer at Tech Corp (Jan 2022 - Present)
    Final Quality Score: 92/100
    
    • [Bullets for this entry...]
    
    ════════════════════════════════════════════════════════════════════════════════
    REMEMBER: Your output must have BOTH:
    1. JSON output (IterativeExperienceOptimization format)
    2. === FINAL OPTIMIZED BULLET POINTS === section (human-readable)
    ════════════════════════════════════════════════════════════════════════════════

    Never fabricate job duties or inflate scope. Your role is to present the actual experience
    in its most compelling and relevant light. Output the complete rewritten experience section.
  expected_output: >
    Your output MUST consist of TWO parts:
    
    PART 1: JSON output conforming to IterativeExperienceOptimization model containing:
    - The original job title, company, and dates for each experience.
    - 3-6 optimized achievement bullets that start with strong action verbs, include
      quantifiable metrics, incorporate keywords, and emphasize impact over activities.
    - Complete iteration_history showing the improvement journey for each entry.
    
    PART 2: A human-readable section titled "=== FINAL OPTIMIZED BULLET POINTS ==="
    that clearly displays the final optimized bullet points for each experience entry.
    This section MUST appear after the JSON output and MUST show:
    - Job title, company name, and date range for each experience
    - Final quality score for each experience
    - All final optimized bullet points in a clear, easy-to-read format
    
    The entire output must demonstrate a clear fit for the target role.
  context:
    - create_alignment_strategy_task
    - extract_resume_content_task
  agent: experience_section_optimizer
  output_file: content/optimized_experience.json

optimize_skills_section_task:
  description: >
    Reorder and optimize the skills section for maximum ATS matching and relevance.
    Your task is to:
    1. Review all skills from the original resume and the job description.
    2. Reorder skills strategically: must-have skills first, then should-have, then nice-to-have.
    3. Use the exact terminology from the job posting where accurate.
    4. Group skills logically (e.g., Technical Skills, Programming Languages, Tools & Platforms).
    5. Strategically add domain-inferred skills while maintaining complete truthfulness.
    6. Remove outdated or irrelevant skills (e.g., COBOL, Visual Basic).

    CRITICAL TRUTHFULNESS RULES - WHAT YOU CAN AND CANNOT ADD:

    ALLOWED (Domain-Based Inference):
    - If candidate worked on "Generative AI" and job requires "LangChain", "Claude", or "OpenAI":
      ADD these as they're standard tools in the Generative AI domain.
    - If candidate used "Python for ML" and job requires "scikit-learn":
      ADD as it's fundamental to the ML ecosystem.
    - If candidate worked with "AWS EC2" and job requires "AWS Lambda":
      ADD as both are AWS services (cloud platform expertise transfer).

    FORBIDDEN (Cannot Add):
    - MLOps if candidate has no MLOps experience (too specific, not inferable).
    - Kubernetes if candidate only worked on frontend development.
    - Terraform if candidate has no Infrastructure as Code experience.
    - Any skill that requires specific knowledge not evidenced in experience.

    DOMAIN EXPERTISE EXAMPLES:
    - Generative AI domain: LangChain, Claude, OpenAI, Hugging Face, Transformers
    - ML/AI domain: scikit-learn, TensorFlow, PyTorch, pandas, NumPy
    - Cloud platforms: AWS services, Azure services, GCP services
    - Web frameworks: React ecosystem, Vue ecosystem, Angular ecosystem
    Optimize the skills section to maximize ATS matching and relevance while maintaining 
    complete truthfulness. Use AI intelligence to analyze the candidate's domain expertise 
    and infer related skills that can be truthfully added.

    YOUR WORKFLOW:
    1. ANALYZE candidate's experience to understand their domain expertise
    2. IDENTIFY missing required skills from job description
    3. INFER related skills based on domain knowledge (use AI reasoning, not hardcoded rules)
    4. VALIDATE each inference against actual experience evidence
    5. PRIORITIZE skills: must-have → should-have → nice-to-have
    6. CATEGORIZE skills using domain-appropriate categories
    7. REMOVE outdated or irrelevant skills

    TRUTHFULNESS FRAMEWORK (CRITICAL):
    
    ASK YOURSELF FOR EACH MISSING SKILL:
    - Is this skill commonly used in the candidate's demonstrated domain?
    - Can I find evidence in their experience supporting this inference?
    - Would an expert in this field agree this inference is reasonable?
    - Is there a logical connection between their experience and this skill?
    
    EXAMPLES OF VALID INFERENCES (Across Domains):
    
    SOFTWARE ENGINEERING:
    ✓ Experience: "Built AI chatbots" + Job needs: "LangChain"
      → ADD: "LangChain" (standard tool in AI chatbot domain)
    ✓ Experience: "React development" + Job needs: "JSX, React Hooks"
      → ADD: Both are core React ecosystem skills
    
    MARKETING:
    ✓ Experience: "SEO campaigns" + Job needs: "Google Analytics"
      → ADD: "Google Analytics" (fundamental SEO tool)
    ✓ Experience: "Email marketing" + Job needs: "A/B testing"
      → ADD: "A/B testing" (standard practice in email marketing)
    
    LEGAL:
    ✓ Experience: "Contract negotiation" + Job needs: "Legal drafting"
      → ADD: "Legal drafting" (integral to contract work)
    ✓ Experience: "Litigation" + Job needs: "Discovery management"
      → ADD: "Discovery management" (core litigation skill)
    
    HEALTHCARE:
    ✓ Experience: "Patient care coordination" + Job needs: "EMR systems"
      → ADD: "EMR systems" (standard in modern patient care)
    ✓ Experience: "Clinical documentation" + Job needs: "ICD-10 coding"
      → ADD: "ICD-10 coding" (fundamental documentation skill)
    
    EXAMPLES OF INVALID INFERENCES:
    ✗ Experience: "Basic Python scripts" + Job needs: "MLOps"
      → REJECT: MLOps requires specialized expertise, not inferable from basic Python
    ✗ Experience: "Frontend development" + Job needs: "Kubernetes"
      → REJECT: Kubernetes is infrastructure, unrelated to frontend work
    ✗ Experience: "Marketing coordinator" + Job needs: "Data science"
      → REJECT: Data science requires specialized training, not inferable from marketing
    
    VALIDATION REQUIREMENTS:
    For EVERY skill you add:
    1. Provide specific evidence from experience (quote actual text)
    2. Explain the logical connection clearly
    3. Rate your confidence (0-100%) and only add if ≥70%
    4. Consider: Would a recruiter in this field accept this inference?
    
    SKILL PRIORITIZATION STRATEGY:
    1. MUST-HAVE (from job): List first, use exact terminology
    2. SHOULD-HAVE (from job): List second
    3. DOMAIN STRENGTHS: Highlight candidate's core expertise
    4. ADDITIONAL: Other relevant skills
    5. LIMIT: Keep total to 15-25 skills for readability
    
    CATEGORIZATION GUIDELINES:
    - Use domain-appropriate category names (not generic)
    - Examples:
      * Software: "Languages", "Frameworks", "Cloud Platforms", "DevOps Tools"
      * Marketing: "Digital Marketing", "Analytics", "Content Creation", "Platforms"
      * Legal: "Practice Areas", "Legal Research", "Documentation", "Systems"
      * Healthcare: "Clinical Skills", "Systems", "Compliance", "Patient Care"
    - Aim for 3-6 categories
    - Group logically by how the industry thinks about skills

    WHAT TO REMOVE:
    - Truly outdated skills (e.g., "Windows XP", "Internet Explorer 6")
    - Irrelevant skills for this role
    - Duplicate/redundant skills (keep the most specific version)
    - Skills not verifiable from experience
    
    ATS OPTIMIZATION:
    - Use exact keywords from job posting where accurate
    - Include variations (e.g., "ML" and "Machine Learning")
    - Place highest-priority keywords in first category
    - Ensure must-have skills are captured

  expected_output: >
    A complete JSON object conforming to the OptimizedSkillsSection model:
    {
      "optimized_skills": [
        {
          "skill_name": "Python",
          "category": "Programming Languages",
          "proficiency_level": "advanced",
          "justification": "Core skill from 5 years experience",
          "evidence": ["Built Python applications for data processing"]
        }
      ],
      "skill_categories": {
        "Programming Languages": ["Python", "JavaScript"],
        "Cloud Platforms": ["AWS", "Docker"],
        "AI & Machine Learning": ["LangChain", "scikit-learn"]
      },
      "added_skills": [
        {
          "skill_name": "LangChain",
          "category": "AI Frameworks",
          "proficiency_level": "intermediate",
          "justification": "Inferred from Generative AI domain expertise. Candidate built AI chatbots and assistants, where LangChain is a standard framework.",
          "evidence": ["Built AI chatbots", "Developed AI assistants"],
          "confidence_score": 0.85
        }
      ],
      "removed_skills": ["Visual Basic", "Internet Explorer"],
      "optimization_notes": "Reordered skills to prioritize must-haves (Python, AWS). Added LangChain based on AI chatbot experience. Removed outdated skills. Categorized by industry standards.",
      "ats_match_score": 87.5
    }

    QUALITY CHECKLIST:
    ✓ Must-have skills from job appear first
    ✓ All added skills have evidence-based justifications
    ✓ Categories are domain-appropriate (not generic)
    ✓ Total skills: 15-25
    ✓ ATS score calculated based on keyword matching
    ✓ No fabricated skills (all verifiable from experience)
    ✓ Removed skills have clear rationale

  context:
    - create_alignment_strategy_task
    - extract_resume_content_task
  agent: skills_section_strategist
  output_file: content/optimized_skills.json

# ============================================================================
# PHASE 4: QUALITY ASSURANCE
# ----------------------------------------------------------------------------
# These final tasks validate the generated resume against all requirements.
# ============================================================================

ats_optimization_task:
  description: >
    Validate and optimize the complete assembled resume for ATS compatibility.
    Your task is to:
    1. Assemble all content components (summary, experience, skills, education) into a valid `Resume` structure.
    2. Use the `validate_and_finalize_resume` tool to generate the final output.
    
    CRITICAL INSTRUCTION:
    Do NOT attempt to generate the final `OptimizedResume` JSON yourself. It is too complex.
    Instead, you must:
    1. Create a valid `Resume` JSON object from the assembled components.
    2. Get the `JobDescription` JSON from the context.
    3. Call `validate_and_finalize_resume(resume_json=..., job_description_json=...)`.
    4. Return the output of this tool call as your final answer.
    
    Perform all validation checks internally via the tool. Do NOT call individual validation functions
    as separate steps.
  expected_output: >
    The JSON output returned by the `validate_and_finalize_resume` tool.
    This will be a single, complete JSON object with the following structure:
    - "resume": object with full resume data
    - "markdown_content": string containing the formatted markdown resume
    - "json_content": string containing the structured JSON resume
    - "ats_validation": object with validation results
    - "optimization_summary": string
    - "components_assembled": object
    - "quality_metrics": object
    
    Output ONLY the valid JSON returned by the tool.
  context:
    - write_professional_summary_task
    - optimize_experience_section_task
    - optimize_skills_section_task
    - extract_resume_content_task
  agent: ats_optimization_specialist
  output_file: validation/ats_report.json

quality_assurance_task:
  description: >
    Conduct the final comprehensive quality review of the tailored resume.
    Your task is to:
    1. Review the complete resume for accuracy, ensuring no exaggerations or false claims.
    2. Check for internal consistency between the summary, experience, and skills sections.
    3. Validate writing quality for grammar, spelling, and professional tone.
    4. Verify strategic alignment, ensuring all critical job requirements are addressed.
    5. Confirm the truthfulness of all claims against the original resume.
    You are the final gatekeeper. Be thorough, critical, and fair.
  expected_output: >
    A comprehensive quality assurance report as a JSON object containing:
    - `approved`: a boolean indicating the final decision.
    - `overall_quality_score`: a 0-100 rating.
    - Detailed checks for accuracy, consistency, writing quality, and strategic alignment.
    - `final_recommendation`: "APPROVED FOR SUBMISSION" or "REQUIRES CORRECTIONS".
    - `corrections_needed`: a specific, prioritized list of corrections if not approved.
    This is the final validation before the resume is considered complete.
  context:
    - ats_optimization_task
    - write_professional_summary_task
    - optimize_experience_section_task
    - optimize_skills_section_task
    - extract_resume_content_task
    - create_alignment_strategy_task
  agent: quality_assurance_reviewer
  output_file: validation/final_qa_report.json
