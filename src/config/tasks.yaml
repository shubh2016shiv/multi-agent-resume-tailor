# ==============================================================================
# TASK CONFIGURATION
# ------------------------------------------------------------------------------
# This file defines the 8 sequential tasks for the Resume Tailor Crew.
# Each task has a clear description of what the assigned agent should do and
# a definition of the "expected_output" which serves as its goal.
#
# WHY YAML?
# - Clarity: Task definitions are centralized and easy to read.
# - Maintainability: You can change task descriptions or expected outputs
#   without modifying the core Python logic.
# - Context Management: The `context` key explicitly defines the data flow
#   and dependencies between tasks.
# ==============================================================================

# ============================================================================
# PHASE 1: DATA EXTRACTION & ANALYSIS (Parallel Tasks)
# ----------------------------------------------------------------------------
# These initial tasks can run in parallel as they have no dependencies on
# each other. They focus on parsing and structuring the input documents.
# ============================================================================

analyze_job_description_task:
  # A detailed description of the agent's objective for this task.
  # It provides step-by-step instructions for the LLM.
  description: >
    Analyze the provided job description file to extract and structure all relevant information.
    Your task is to:
    1. Read and parse the job description file from the path provided in inputs.
    2. Extract the job title, company name, and identify the seniority level.
    3. Identify all requirements and qualifications, categorizing each as:
       - Must-have (e.g., required, mandatory, essential)
       - Should-have (e.g., preferred, desired)
       - Nice-to-have (e.g., bonus, plus)
    4. Extract specific skills mentioned, paying close attention to technical skills,
       required years of experience, and necessary certifications.
    5. Identify key responsibilities and what success looks like in the role.
    6. Extract company culture indicators from the language and tone used.
    7. Compile a comprehensive list of ATS keywords that are critical for the resume.
    Use the `job_analyzer` tool to parse the file, but enhance the analysis with your
    expertise in reading between the lines to identify implicit requirements.
    Output a structured `JobDescription` model with your complete analysis.
  
  # Defines the success criteria for the task. The agent will work until its
  # output matches this description of a completed task.
  expected_output: >
    A comprehensive JSON object representing a `JobDescription`. This object must include:
    - Job title and company name.
    - The detected seniority level.
    - A categorized list of requirements (at least 20 items with importance levels).
    - A list of must-have keywords for ATS optimization.
    - A breakdown of key responsibilities.
    - Insights into the company culture.
    The output must be a valid JSON that conforms to the `JobDescription` model structure.
  
  # Specifies which agent is responsible for this task.
  agent: job_description_analyst
  
  # Defines where the output of this task will be saved.
  output_file: analysis/job_analysis.json

extract_resume_content_task:
  description: >
    Extract and structure the candidate's resume information using LLM-based extraction.
    Your task is to:
    1. Use the `resume_extractor` tool to load and convert the resume file into clean Markdown.
    2. Analyze the Markdown content and extract all information into a structured `Resume` model, including:
       - Personal information (name, email, phone, location).
       - The professional summary or objective.
       - All work experience entries with job titles, companies, dates, descriptions,
         quantifiable achievements, and skills used in each role.
       - The education section with degrees, institutions, and graduation years.
       - The skills section, categorized into technical, soft, and domain-specific skills.
    3. Identify patterns of career growth and areas of deep expertise.
    4. Calculate the total years of professional experience.
    5. Ensure the accuracy and completeness of all extracted data.
    The `resume_extractor` tool handles PDF, DOCX, and text files. You will parse the
    clean Markdown it returns to populate the `Resume` model accurately.
    Output a structured `Resume` model with the complete career history.
  expected_output: >
    A comprehensive JSON object representing a `Resume`. This object must include:
    - Complete personal information.
    - The professional summary.
    - All work experiences (at least 3 entries) with detailed achievements.
    - A full education history.
    - A categorized list of skills (at least 20 skills).
    - A calculation of the total years of experience.
    The output must be a valid JSON that conforms to the `Resume` model structure.
  agent: resume_content_extractor
  output_file: analysis/resume_extraction.json

# ============================================================================
# PHASE 2: STRATEGIC ANALYSIS
# ----------------------------------------------------------------------------
# This task depends on the outputs of Phase 1 to create the tailoring strategy.
# ============================================================================

create_alignment_strategy_task:
  description: >
    Create a comprehensive strategy for aligning the resume with the job requirements.
    Your task is to:
    1. Compare the extracted job requirements against the candidate's experience and skills.
    2. Identify all skill matches, categorizing them as direct, transferable, or implicit.
    3. Calculate a match percentage for each requirement.
    4. Identify all skill gaps, assessing whether they are deal-breakers or addressable.
    5. Create strategic recommendations on which experiences to emphasize, how to reframe
       achievements, which skills to prioritize, and which keywords must be incorporated.
    6. Develop content guidance for each section of the resume (summary, experience, skills).
    7. Set a target keyword density and identify high-priority keywords for ATS optimization.
    Be analytical but also creative in identifying matches. Many apparent gaps are simply
    differences in terminology. Remain honest about true gaps and suggest how to address them
    without fabrication. Output a complete `AlignmentStrategy` that will guide all subsequent
    content generation agents.
  expected_output: >
    A detailed JSON object representing an `AlignmentStrategy`. This object must include:
    - An overall fit percentage (0-100).
    - A list of matched skills with quality scores.
    - A list of skill gaps with suggestions for addressing each.
    - A focus statement for the professional summary.
    - A prioritized list of experiences to highlight.
    - A skills prioritization strategy.
    - A list of high-priority keywords (at least 15).
    - Recommendations for reframing achievements and changing emphasis.
    The output must contain specific, actionable guidance that content writers can follow directly
    and conform to the `AlignmentStrategy` model structure.
  
  # This task depends on the completion of the two tasks above.
  # The output of these tasks will be available in this task's context.
  context:
    - analyze_job_description_task
    - extract_resume_content_task
  agent: gap_alignment_strategist
  output_file: analysis/alignment_strategy.json

# ============================================================================
# PHASE 3: CONTENT GENERATION
# ----------------------------------------------------------------------------
# These tasks generate the new, tailored content based on the strategy.
# ============================================================================

write_professional_summary_task:
  description: >
    Write a compelling professional summary tailored to the target job.
    Your task is to generate 4 distinct drafts using different strategic frameworks.
    
    IMPORTANT: You must output a valid JSON object directly. Do NOT attempt to use tools.
    Perform all analysis and self-critique internally, then output the final structured result.
    
    Generate these 4 drafts:
    
    1. **Draft A (The Hook-Value-Future Framework)**:
       - Sentence 1 (Hook): Lead with the most impressive fact/number.
       - Sentences 2-3 (Value): Connect skills to outcomes ("Reduced X by Y%").
       - Final Sentence (Future): Align with company mission/values.
       
    2. **Draft B (The Story Spine)**:
       - Focus on the narrative arc: "Once upon a time... Until one day... And now..."
       - Emphasize career evolution and the "why" behind the candidate's path.
       
    3. **Draft C (The Specialist/Keyword Camouflage)**:
       - Maximize ATS keyword density but "camouflage" them within achievement contexts.
       - Focus on deep technical specificity and hard skills.
       
    4. **Draft D (The Balanced Hybrid)**:
       - The best balance of readability, impact, and ATS optimization.
       
    For each draft, internally perform:
    - "Specificity Test": Ensure every claim is backed by a number, tech, or outcome.
    - "Energy Audit": Ensure active voice and momentum.
    - Self-critique: Note strengths/weaknesses and assign a confidence score (0-100).
    
    Then output the complete JSON structure with all 4 drafts and your recommendation.
  expected_output: >
    A valid JSON object conforming to the ProfessionalSummary model structure:
    {
      "drafts": [
        {
          "version_name": "Hook-Value-Future",
          "strategy_used": "Brief description of strategy",
          "content": "The actual summary text (75-150 words)",
          "critique": "Self-critique of this draft",
          "score": 85
        },
        ... (3 more drafts)
      ],
      "recommended_version": "Hook-Value-Future",
      "writing_notes": "Overall notes about trade-offs between versions"
    }
    
    Each draft must be 75-150 words. Include all 4 drafts. Provide your recommendation.
  context:
    - create_alignment_strategy_task
  agent: professional_summary_writer
  output_file: content/professional_summary.txt

optimize_experience_section_task:
  description: >
    Rewrite and optimize all experience entries to align with the target job.
    Your task is to:
    1. Review each experience entry from the original resume.
    2. For each entry, reorder bullets by relevance to the target job:
       - Bullets with direct keyword matches go first
       - High-impact achievements (revenue, scale, cost savings) prioritized
       - Leadership/team accomplishments highlighted
       - Generic duties moved to end or removed
    3. Rewrite descriptions to incorporate job-relevant keywords naturally.
    4. Reframe achievements to emphasize the most relevant aspects.
    5. Quantify achievements wherever possible, using a Challenge-Action-Result (CAR) format.
    6. Ensure each bullet starts with a strong action verb (e.g., "Led", "Architected", "Increased").
    
    Apply the "So What?" Test to every bullet:
    - If a bullet describes WHAT you did without WHY it mattered, rewrite it.
    - Transform: "Built microservices" → "Built microservices architecture that reduced deployment time from 2 hours to 15 minutes"
    - Every bullet must answer: What business problem did this solve? Who benefited? What changed?
    
    Hierarchy of Impact (use highest level possible):
    1. Revenue/Cost: "Generated $2M in savings" (BEST)
    2. Efficiency: "Reduced processing time by 70%"
    3. Scale: "Enabled platform to support 50M users"
    4. Quality: "Decreased bug rate by 40%"
    5. Capability: "Enabled real-time analytics previously impossible"

    Bullet Structure Requirements:
    1. Lead with strong action verb
    2. Include context/scale early (team size, dataset size, user base)
    3. Specify method/technology used
    4. End with measurable impact
    
    Formula: "[Verb] [what] for [scale/context], [method], resulting in [impact]"
    
    Example: "Architected microservices platform for 50M+ users using Kubernetes and Python, 
              reducing infrastructure costs by $2M annually and improving deployment speed by 300%"

    ITERATIVE IMPROVEMENT PROCESS (MANDATORY):
    You MUST use the evaluate_experience_bullets tool for iterative improvement.
    DO NOT skip this process. Follow this exact workflow for EACH experience entry:
    
    FOR EACH experience entry (repeat this entire block per entry):
      Set ITERATION_COUNT = 0
      Set CONTINUE_IMPROVING = True
      Set iteration_history = []
      
      WHILE CONTINUE_IMPROVING AND ITERATION_COUNT < 3:
        ITERATION_COUNT = ITERATION_COUNT + 1
        
        # Step 1: Generate or Regenerate bullets
        IF ITERATION_COUNT == 1:
          bullets = [Generate 3-6 initial bullets based on original resume and strategy guidance]
        ELSE:
          bullets = [Regenerate 3-6 bullets addressing the specific critique from previous iteration]
        
        # Step 2: Evaluate using the tool (MANDATORY)
        evaluation_result = evaluate_experience_bullets(
          bullets_json=json.dumps(bullets),
          keywords="comma,separated,keywords,from,strategy",
          strategy_json=json.dumps(alignment_strategy)
        )
        
        # Step 3: Parse evaluation result
        Parse JSON from evaluation_result to get:
          - average_score (int)
          - per_bullet_scores (list)
          - issues (list of specific problems)
          - critique (actionable improvement instructions)
          - meets_threshold (bool)
        
        # Step 4: Record this iteration
        iteration_history.append({
          "iteration": ITERATION_COUNT,
          "content": "\n".join(bullets),
          "quality_score": average_score,
          "issues_found": issues,
          "critique": critique
        })
        
        # Step 5: Log progress
        LOG: "Iteration {ITERATION_COUNT} for {company_name}: Score {average_score}/100"
        
        # Step 6: Decide whether to continue
        IF meets_threshold:
          CONTINUE_IMPROVING = False
          LOG: "✓ Quality threshold met at iteration {ITERATION_COUNT}"
        ELSE IF ITERATION_COUNT >= 3:
          CONTINUE_IMPROVING = False
          LOG: "⚠ Max iterations reached. Final score: {average_score}/100"
        ELSE:
          LOG: "↻ Regenerating bullets based on critique: {critique}"
          # Loop will continue with regeneration
      
      # Step 7: Store final bullets and history for this entry
      final_bullets = bullets
      final_score = average_score
    
    OUTPUT FORMAT REQUIREMENTS:
    You MUST output using the IterativeExperienceOptimization model:
    {
      "optimized_experiences": [Experience objects with final bullets],
      "optimization_notes": "Summary of optimization decisions",
      "keywords_integrated": ["list", "of", "keywords", "used"],
      "relevance_scores": {"Company Name": relevance_score},
      "iteration_history": {
        "Company Name": [list of BulletDraft objects showing each iteration]
      },
      "iterations_used": total_number_of_iterations_across_all_entries,
      "final_quality_score": average_final_score_across_all_entries
    }
    
    CRITICAL: You MUST call evaluate_experience_bullets after generating bullets.
    CRITICAL: You MUST regenerate bullets if score < 85.
    CRITICAL: You MUST include iteration_history in your output.
    
    ════════════════════════════════════════════════════════════════════════════════
    CRITICAL OUTPUT REQUIREMENT - FINAL BULLET POINTS DISPLAY
    ════════════════════════════════════════════════════════════════════════════════
    
    AFTER your JSON output, you MUST ALWAYS add a human-readable section that clearly
    displays the final optimized bullet points. This section MUST be titled exactly:
    
    === FINAL OPTIMIZED BULLET POINTS ===
    
    This section is REQUIRED and makes it easy for users to see the final results at a glance.
    DO NOT skip this section. It must appear after your JSON output.
    
    Format for the FINAL BULLET POINTS section:
    
    === FINAL OPTIMIZED BULLET POINTS ===
    
    [Job Title] at [Company Name] ([Start Date] - [End Date or Present])
    Final Quality Score: [Score]/100
    
    • [First optimized bullet point]
    • [Second optimized bullet point]
    • [Third optimized bullet point]
    [Add more bullets as needed]
    
    [Repeat this format for EACH experience entry]
    
    Example:
    
    === FINAL OPTIMIZED BULLET POINTS ===
    
    Software Engineer at Test Company (Jan 2021 - Present)
    Final Quality Score: 88/100
    
    • Architected microservices platform for 50M+ users using Kubernetes and Python, reducing infrastructure costs by 40%
    • Led cross-functional team of 8 engineers using Agile methodologies, delivering $2M cost-saving automation initiative
    • Engineered CI/CD pipeline using Docker and AWS, improving release frequency by 300%
    
    Senior Engineer at Tech Corp (Jan 2022 - Present)
    Final Quality Score: 92/100
    
    • [Bullets for this entry...]
    
    ════════════════════════════════════════════════════════════════════════════════
    REMEMBER: Your output must have BOTH:
    1. JSON output (IterativeExperienceOptimization format)
    2. === FINAL OPTIMIZED BULLET POINTS === section (human-readable)
    ════════════════════════════════════════════════════════════════════════════════

    Never fabricate job duties or inflate scope. Your role is to present the actual experience
    in its most compelling and relevant light. Output the complete rewritten experience section.
  expected_output: >
    Your output MUST consist of TWO parts:
    
    PART 1: JSON output conforming to IterativeExperienceOptimization model containing:
    - The original job title, company, and dates for each experience.
    - 3-6 optimized achievement bullets that start with strong action verbs, include
      quantifiable metrics, incorporate keywords, and emphasize impact over activities.
    - Complete iteration_history showing the improvement journey for each entry.
    
    PART 2: A human-readable section titled "=== FINAL OPTIMIZED BULLET POINTS ==="
    that clearly displays the final optimized bullet points for each experience entry.
    This section MUST appear after the JSON output and MUST show:
    - Job title, company name, and date range for each experience
    - Final quality score for each experience
    - All final optimized bullet points in a clear, easy-to-read format
    
    The entire output must demonstrate a clear fit for the target role.
  context:
    - create_alignment_strategy_task
    - extract_resume_content_task
  agent: experience_section_optimizer
  output_file: content/optimized_experience.json

optimize_skills_section_task:
  description: >
    Reorder and optimize the skills section for maximum ATS matching and relevance.
    Your task is to:
    1. Review all skills from the original resume and the job description.
    2. Reorder skills strategically: must-have skills first, then should-have, then nice-to-have.
    3. Use the exact terminology from the job posting where accurate.
    4. Group skills logically (e.g., Technical Skills, Programming Languages, Tools & Platforms).
    5. Ensure every skill listed is verifiable from the experience section.
    Never add skills the candidate doesn't possess. Your output directly impacts the ATS matching score.
  expected_output: >
    An optimized skills section as a JSON object with categorized skill lists. For example:
    {
      "technical_skills": ["Prioritized", "List", "Of", "Technical", "Skills"],
      "programming_languages": ["Languages", "In", "Priority", "Order"],
      "tools_platforms": ["Tools", "And", "Platforms"]
    }
    Each category must list skills in order of relevance to the job posting and use exact
    terminology where applicable.
  context:
    - create_alignment_strategy_task
    - extract_resume_content_task
  agent: skills_section_strategist
  output_file: content/optimized_skills.json

# ============================================================================
# PHASE 4: QUALITY ASSURANCE
# ----------------------------------------------------------------------------
# These final tasks validate the generated resume against all requirements.
# ============================================================================

ats_optimization_task:
  description: >
    Validate and optimize the complete assembled resume for ATS compatibility.
    Your task is to:
    1. Assemble all content components (summary, experience, skills, education).
    2. Verify that all must-have keywords from the job posting appear at least once.
    3. Check that keyword density is optimal (2-5% overall) and not stuffed.
    4. Validate formatting for ATS parsing (no tables, columns, or complex layouts).
    5. Ensure standard section headers are used (e.g., "Experience", "Skills", "Education").
    6. Use the `document_formatter` tool to generate the final Markdown and JSON outputs.
    Your goal is to ensure this resume passes automated screening to reach a human reviewer.
  expected_output: >
    An ATS validation report as a JSON object containing:
    - `ats_compatible`: a boolean indicating success.
    - `keyword_match_score`: percentage of must-have keywords present.
    - `formatting_issues`: a list of any detected issues.
    - `recommendations`: specific fixes needed if not compatible.
    - `file_paths`: paths to the generated markdown and json files.
    If `ats_compatible` is false, provide actionable fixes.
  context:
    - write_professional_summary_task
    - optimize_experience_section_task
    - optimize_skills_section_task
    - extract_resume_content_task
  agent: ats_optimization_specialist
  output_file: validation/ats_report.json

quality_assurance_task:
  description: >
    Conduct the final comprehensive quality review of the tailored resume.
    Your task is to:
    1. Review the complete resume for accuracy, ensuring no exaggerations or false claims.
    2. Check for internal consistency between the summary, experience, and skills sections.
    3. Validate writing quality for grammar, spelling, and professional tone.
    4. Verify strategic alignment, ensuring all critical job requirements are addressed.
    5. Confirm the truthfulness of all claims against the original resume.
    You are the final gatekeeper. Be thorough, critical, and fair.
  expected_output: >
    A comprehensive quality assurance report as a JSON object containing:
    - `approved`: a boolean indicating the final decision.
    - `overall_quality_score`: a 0-100 rating.
    - Detailed checks for accuracy, consistency, writing quality, and strategic alignment.
    - `final_recommendation`: "APPROVED FOR SUBMISSION" or "REQUIRES CORRECTIONS".
    - `corrections_needed`: a specific, prioritized list of corrections if not approved.
    This is the final validation before the resume is considered complete.
  context:
    - ats_optimization_task
    - write_professional_summary_task
    - optimize_experience_section_task
    - optimize_skills_section_task
    - extract_resume_content_task
    - create_alignment_strategy_task
  agent: quality_assurance_reviewer
  output_file: validation/final_qa_report.json
